<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>


    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .font-handwriting {
            font-family: 'Segoe Print', 'Comic Sans MS', cursive;
            font-weight: 600;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const IconBase = ({ d, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {d}
            </svg>
        );
        const BookOpen = (p) => <IconBase {...p} d={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></>} />;
        const CheckCircle = (p) => <IconBase {...p} d={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></>} />;
        const XCircle = (p) => <IconBase {...p} d={<><circle cx="12" cy="12" r="10" /><line x1="15" y1="9" x2="9" y2="15" /><line x1="9" y1="9" x2="15" y2="15" /></>} />;
        const ArrowRight = (p) => <IconBase {...p} d={<><line x1="5" y1="12" x2="19" y2="12" /><polyline points="12 5 19 12 12 19" /></>} />;
        const Home = (p) => <IconBase {...p} d={<><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></>} />;
        const Star = (p) => <IconBase {...p} d={<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />} />;
        const RefreshCw = (p) => <IconBase {...p} d={<><path d="M23 4v6h-6" /><path d="M1 20v-6h6" /><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" /></>} />;

        const User = (p) => <IconBase {...p} d={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>} />;
        const Edit = (p) => <IconBase {...p} d={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></>} />;
        const Bell = (p) => <IconBase {...p} d={<><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" /><path d="M13.73 21a2 2 0 0 1-3.46 0" /></>} />;
        const Trash2 = (p) => <IconBase {...p} d={<><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></>} />;

        const LogOut = (p) => <IconBase {...p} d={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></>} />;
        const RotateCcw = (p) => <IconBase {...p} d={<><polyline points="1 4 1 10 7 10" /><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" /></>} />;
        const Share2 = (p) => <IconBase {...p} d={<><circle cx="18" cy="5" r="3" /><circle cx="6" cy="12" r="3" /><circle cx="18" cy="19" r="3" /><line x1="8.59" y1="13.51" x2="15.42" y2="17.49" /><line x1="15.41" y1="6.51" x2="8.59" y2="10.49" /></>} />;
        const X = (p) => <IconBase {...p} d={<path d="M18 6L6 18M6 6l12 12" />} />;

        // --- Data ---
        const grammarData = {
            present: {
                title: "ç¾åœ¨ç°¡å–®å¼ (Present Simple)",
                icon: "â˜€ï¸",
                color: "bg-yellow-100",
                borderColor: "border-yellow-400",
                btnColor: "bg-yellow-400 hover:bg-yellow-500",
                progressColor: "bg-yellow-500",
                textColor: "text-yellow-800",
                rules: [
                    { title: "ä½¿ç”¨æ™‚æ©Ÿ", content: "äº‹å¯¦ã€ç¿’æ…£ã€æ™®éçœŸç†ï¼Œæˆ–é å®šçš„è¡Œç¨‹ã€‚", example: "I walk to work. (æˆ‘èµ°è·¯å»ä¸Šç­)" },
                    { title: "He / She / It çš„ç§˜å¯†", content: "ç•¶ä¸»è©æ˜¯ç¬¬ä¸‰äººç¨±å–®æ•¸ (He, She, It) æ™‚ï¼Œå‹•è©å­—å°¾è¦åŠ  -s æˆ– -es å–”ï¼", example: "She walks to work. (å¥¹èµ°è·¯å»ä¸Šç­)" },
                    { title: "å¦å®šå¥æ€éº¼è®Šï¼Ÿ", content: "I/You/We/They ç”¨ 'do not (don't)'ã€‚\nHe/She/It ç”¨ 'does not (doesn't)'ã€‚", example: "We don't walk. / He doesn't walk." }
                ],
                questions: [
                    { q: "I __________ (not / drink) coffee in the morning.", a: "do not drink", alt: ["don't drink"] },
                    { q: "She __________ (play) the piano beautifully.", a: "plays" },
                    { q: "They __________ (not / live) in London anymore.", a: "do not live", alt: ["don't live"] },
                    { q: "It __________ (rain) a lot during the winter here.", a: "rains" },
                    { q: "You __________ (always / forget) your keys on the table.", a: "always forget" },
                    { q: "He __________ (not / like) spicy food.", a: "does not like", alt: ["doesn't like"] },
                    { q: "We __________ (study) English every Tuesday.", a: "study" }
                ]
            },
            past: {
                title: "éå»ç°¡å–®å¼ (Past Simple)",
                icon: "ğŸ•°ï¸",
                color: "bg-blue-100",
                borderColor: "border-blue-400",
                btnColor: "bg-blue-400 hover:bg-blue-500",
                progressColor: "bg-blue-500",
                textColor: "text-blue-800",
                rules: [
                    { title: "ä½¿ç”¨æ™‚æ©Ÿ", content: "åœ¨éå»ç‰¹å®šæ™‚é–“é»é–‹å§‹ä¸¦å·²å®Œæˆçš„å‹•ä½œã€‚", example: "They cooked dinner. (ä»–å€‘ç…®äº†æ™šé¤)" },
                    { title: "å¦å®šå¥çš„å°é™·é˜±", content: "å¦å®šå¥ä½¿ç”¨ did not (didn't) + åŸå½¢å‹•è©ï¼åƒè¬ä¸è¦åŠ  ed å–”ï¼", example: "It did not cook dinner. (å®ƒæ²’ç…®æ™šé¤ - æ­£ç¢º)\nIt did not cooked... (éŒ¯èª¤ âŒ)" }
                ],
                questions: [
                    { q: "I __________ (see) a movie last night.", a: "saw" },
                    { q: "You __________ (not / call) me yesterday.", a: "did not call", alt: ["didn't call"] },
                    { q: "He __________ (buy) a new car last week.", a: "bought" },
                    { q: "They __________ (not / finish) their homework on time.", a: "did not finish", alt: ["didn't finish"] },
                    { q: "It __________ (be) very cold two days ago.", a: "was" },
                    { q: "We __________ (not / go) to the beach because of the rain.", a: "did not go", alt: ["didn't go"] },
                    { q: "She __________ (tell) me a secret this morning.", a: "told" }
                ]
            },
            future: {
                title: "æœªä¾†ç°¡å–®å¼ (Future Simple)",
                icon: "ğŸš€",
                color: "bg-green-100",
                borderColor: "border-green-400",
                btnColor: "bg-green-400 hover:bg-green-500",
                progressColor: "bg-green-500",
                textColor: "text-green-800",
                rules: [
                    { title: "ä½¿ç”¨æ™‚æ©Ÿ", content: "æ‰¿è«¾ã€é æ¸¬ï¼Œæˆ–æ˜¯èªªè©±ç•¶ä¸‹æ‰€åšçš„æ±ºå®šã€‚", example: "I will travel soon. (æˆ‘å¾ˆå¿«å°±æœƒå»æ—…è¡Œ)" },
                    { title: "å¦å®šå¥èˆ‡ç¸®å¯«", content: "will not å¯ä»¥ç¸®å¯«æˆ won'tã€‚", example: "They will not (won't) travel." }
                ],
                questions: [
                    { q: "I promise I __________ (help) you with your project tomorrow.", a: "will help" },
                    { q: "They __________ (not / arrive) before 8:00 PM.", a: "will not arrive", alt: ["won't arrive"] },
                    { q: "It __________ (be) a sunny day on Sunday.", a: "will be" },
                    { q: "You __________ (not / regret) this decision.", a: "will not regret", alt: ["won't regret"] },
                    { q: "We __________ (travel) to Japan next summer.", a: "will travel" },
                    { q: "He __________ (not / join) us for dinner tonight.", a: "will not join", alt: ["won't join"] },
                    { q: "She __________ (be) a great doctor one day.", a: "will be" }
                ]
            },
            mixed: {
                title: "æ··åˆæ™‚æ…‹æŒ‘æˆ° (Mixed Challenge)",
                icon: "ğŸ†",
                color: "bg-purple-100",
                borderColor: "border-purple-400",
                btnColor: "bg-purple-400 hover:bg-purple-500",
                progressColor: "bg-purple-500",
                textColor: "text-purple-800",
                rules: [
                    { title: "å¤§é­”ç‹é—œå¡", content: "é€™è£¡æ··åˆäº†æ‰€æœ‰æ™‚æ…‹ï¼è«‹ä»”ç´°çœ‹æ™‚é–“é—œéµå­— (Time Markers)ã€‚", example: "yesterday (éå»), always (ç¾åœ¨ç¿’æ…£), next year (æœªä¾†)" }
                ],
                questions: [
                    { q: "Last year, I __________ (travel) to France.", a: "traveled", alt: ["travelled"] },
                    { q: "Every morning, he __________ (eat) breakfast at 7 AM.", a: "eats" },
                    { q: "I think it __________ (snow) tomorrow.", a: "will snow" },
                    { q: "We __________ (not / see) that movie yet, but we saw the trailer yesterday.", a: "have not seen", alt: ["haven't seen", "did not see", "didn't see"] },
                    { q: "They __________ (not / play) football every weekend; they prefer tennis.", a: "do not play", alt: ["don't play"] },
                    { q: "She __________ (not / come) to the party last night.", a: "did not come", alt: ["didn't come"] }
                ]
            }
        };

        // --- Helper Components ---
        const CartoonCard = ({ children, color, borderColor, className = "" }) => (
            <div className={`${color} border-4 ${borderColor} rounded-3xl shadow-[8px_8px_0px_0px_rgba(0,0,0,0.15)] p-6 transition-transform hover:-translate-y-1 ${className}`}>
                {children}
            </div>
        );

        const Button = ({ onClick, children, colorClass, className = "" }) => (
            <button
                onClick={onClick}
                className={`${colorClass} text-white font-bold py-3 px-6 rounded-2xl shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)] active:shadow-none active:translate-y-1 transition-all flex items-center justify-center gap-2 ${className}`}
            >
                {children}
            </button>
        );

        const FeedbackModal = ({ isCorrect, correctAnswer, onNext }) => (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
                <div className={`bg-white rounded-3xl p-8 max-w-sm w-full text-center border-b-8 ${isCorrect ? 'border-green-500' : 'border-red-500'} shadow-2xl scale-100 animate-in zoom-in-95 duration-200`}>
                    <div className="text-6xl mb-4 animate-bounce">{isCorrect ? 'ğŸ‰' : 'ğŸ¤”'}</div>
                    <h3 className={`text-2xl font-black mb-2 ${isCorrect ? 'text-green-600' : 'text-red-600'}`}>
                        {isCorrect ? 'ç­”å°äº†ï¼ Awesome!' : 'å·®ä¸€é»é»ï¼'}
                    </h3>

                    <Button onClick={onNext} colorClass={isCorrect ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-500 hover:bg-gray-600'} className="w-full text-lg">
                        {isCorrect ? 'ä¸‹ä¸€é¡Œ Next!' : 'æˆ‘çŸ¥é“äº† Got it!'}
                    </Button>
                </div>
            </div>
        );

        // --- Main App ---
        function App() {
            // States
            const [userName, setUserName] = useState("");
            const [showNameModal, setShowNameModal] = useState(true);
            const [history, setHistory] = useState([]); // Array of record objects
            const [currentSection, setCurrentSection] = useState(null);
            const [mode, setMode] = useState(null);

            // Quiz States
            const [currentQuestionIdx, setCurrentQuestionIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [userInput, setUserInput] = useState("");
            const [showFeedback, setShowFeedback] = useState(false);
            const [lastResult, setLastResult] = useState(null);
            const [completed, setCompleted] = useState(false);

            // Log for current session
            const [quizLog, setQuizLog] = useState([]); // [{q, userAns, correctAns, isCorrect}]

            const [notification, setNotification] = useState(null);
            const [showReportModal, setShowReportModal] = useState(false);
            const [selectedRecord, setSelectedRecord] = useState(null);
            const [isExporting, setIsExporting] = useState(false);
            const [reportImageUrl, setReportImageUrl] = useState(null);
            const reportRef = useRef(null);

            // Init: Load from localStorage
            useEffect(() => {
                const savedData = localStorage.getItem('grammar_adventure_data');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    // Handle legacy data or new data
                    if (parsed.userName) {
                        setUserName(parsed.userName);
                        setShowNameModal(false);
                    }
                    if (parsed.history) {
                        setHistory(parsed.history);
                    }
                }
            }, []);

            // Save to localStorage whenever critical data changes
            useEffect(() => {
                if (userName || history.length > 0) {
                    const dataToSave = { userName, history };
                    localStorage.setItem('grammar_adventure_data', JSON.stringify(dataToSave));
                }
            }, [userName, history]);

            // Calculate progress for home screen (USER SPECIFIC)
            const getProgress = (sectionKey) => {
                if (!userName) return 0;
                const sectionAttempts = history.filter(h => h.sectionKey === sectionKey && h.userName === userName);
                if (sectionAttempts.length === 0) return 0;
                // Find best score
                const maxScore = Math.max(...sectionAttempts.map(h => h.score));
                return maxScore;
            };

            const handleSectionSelect = (sectionKey) => {
                setCurrentSection(sectionKey);
                setMode(null);
            };

            const resetQuiz = () => {
                setCurrentQuestionIdx(0);
                setScore(0);
                setCompleted(false);
                setUserInput("");
                setShowFeedback(false);
                setQuizLog([]);
            };

            const startQuiz = () => {
                setMode('quiz');
                resetQuiz();
            };

            const checkAnswer = () => {
                if (!userInput.trim()) return;

                const currentQ = grammarData[currentSection].questions[currentQuestionIdx];
                const userClean = userInput.trim().toLowerCase();
                const isCorrect = userClean === currentQ.a.toLowerCase() || (currentQ.alt && currentQ.alt.includes(userClean));

                const newScore = isCorrect ? score + 1 : score;
                if (isCorrect) setScore(newScore);

                // Add to temporary log
                const logEntry = {
                    question: currentQ.q,
                    userAnswer: userInput,
                    correctAnswer: currentQ.a,
                    isCorrect: isCorrect,
                    questionId: currentQuestionIdx
                };
                setQuizLog(prev => [...prev, logEntry]);

                // ç›´æ¥é€²å…¥ä¸‹ä¸€é¡Œ
                setUserInput("");
                if (currentQuestionIdx < grammarData[currentSection].questions.length - 1) {
                    setCurrentQuestionIdx(prev => prev + 1);
                } else {
                    // é€™è£¡è¦æŠŠæœ€å¾Œä¸€ç­† log åŠ å…¥å¾Œå† finishï¼Œå› ç‚º setState æ˜¯éåŒæ­¥çš„
                    // ä½†å› ç‚º React æ‰¹æ¬¡è™•ç†ï¼Œæˆ‘å€‘ç›´æ¥æ‹¿ç•¶å‰ logEntry å‚³éæˆ–è€…ä¾è³´ useEffect
                    finishQuiz([...quizLog, logEntry]);
                }
            };

            const nextQuestion = () => {
                // æ­¤å‡½å¼åœ¨ç›´æ¥ä½œç­”æ¨¡å¼ä¸‹ä¸å†è¢« FeedbackModal è§¸ç™¼
                setShowFeedback(false);
                setUserInput("");

                if (currentQuestionIdx < grammarData[currentSection].questions.length - 1) {
                    setCurrentQuestionIdx(prev => prev + 1);
                } else {
                    finishQuiz();
                }
            };

            const finishQuiz = (finalLog) => {
                setCompleted(true);

                const finalRecord = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    sectionKey: currentSection,
                    userName: userName,
                    score: score,
                    total: grammarData[currentSection].questions.length,
                    details: finalLog || quizLog
                };

                setHistory(prev => [finalRecord, ...prev]);
            };

            const closeReportModal = () => {
                setSelectedRecord(null);
                setShowReportModal(false);
                setReportImageUrl(null);
            };

            const exportReport = async () => {
                if (!reportRef.current) return;
                setIsExporting(true);
                await new Promise(r => setTimeout(r, 500));
                try {
                    const canvas = await html2canvas(reportRef.current, {
                        scale: 2,
                        backgroundColor: "#ffffff",
                        logging: false,
                        useCORS: true
                    });

                    const dataUrl = canvas.toDataURL('image/png');
                    setReportImageUrl(dataUrl);
                    // We skip auto-navigator.share to focus on the preview for all users
                } catch (err) {
                    console.error(err);
                    alert("æ–¹æ¡ˆç”Ÿæˆå¤±æ•—ï¼Œè«‹æˆªåœ–æˆ–é‡è©¦");
                } finally {
                    setIsExporting(false);
                }
            };

            const handleGoHome = () => {
                if (completed) {
                    const sections = Object.keys(grammarData);
                    const currentIndex = sections.indexOf(currentSection);
                    if (currentIndex < sections.length - 1) {
                        const nextTitle = grammarData[sections[currentIndex + 1]].title;
                        setNotification(`å¤ªæ£’äº†ï¼æ¥ä¸‹ä¾†æŒ‘æˆ°ã€Œ${nextTitle}ã€å§ï¼ğŸ‘‰`);
                    } else {
                        setNotification("æ­å–œï¼ä½ å·²ç¶“å®Œæˆæ‰€æœ‰èª²ç¨‹äº†ï¼ğŸ“");
                    }
                    setTimeout(() => setNotification(null), 5000);
                }
                setCurrentSection(null);
                setMode(null);
            };

            const handleNameSubmit = (e) => {
                e.preventDefault();
                if (userName.trim()) setShowNameModal(false);
            };

            const handleSwitchUser = () => {
                // Clear current user session, but keep history
                setUserName("");
                setCurrentSection(null);
                setShowNameModal(true);
            };

            const resetMyProgress = () => {
                if (confirm(`ç¢ºå®šè¦é‡ç½®ã€Œ${userName}ã€çš„æ‰€æœ‰å­¸ç¿’é€²åº¦å—ï¼Ÿ(é€™ä¸æœƒå½±éŸ¿å…¶ä»–ä½¿ç”¨è€…çš„ç´€éŒ„)`)) {
                    setHistory(prev => prev.filter(h => h.userName !== userName));
                    alert("é€²åº¦å·²é‡ç½®ï¼");
                }
            };

            const deleteRecord = (id) => {
                if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
                    setHistory(prev => prev.filter(h => h.id !== id));
                }
            };

            const viewRecord = (record) => {
                setSelectedRecord(record);
                setShowReportModal(true);
            };

            const clearAllHistory = () => {
                if (confirm("è­¦å‘Šï¼šé€™å°‡æœƒæ¸…é™¤ã€Œæ‰€æœ‰ä½¿ç”¨è€…ã€çš„ç´€éŒ„ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                    setHistory([]);
                }
            };



            // Filtered history for display
            const userHistory = history.filter(h => h.userName === userName);

            // --- Views ---

            const recordsToDisplay = selectedRecord ? [selectedRecord] : Object.entries(grammarData).map(([sKey, d]) => userHistory.find(h => h.sectionKey === sKey)).filter(Boolean);
            const currentSectionData = currentSection ? grammarData[currentSection] : null;

            // Report Modal
            if (showReportModal) {
                return (
                    <div className="fixed inset-0 bg-black/80 z-50 overflow-y-auto p-4 md:p-8">
                        <div className="max-w-4xl mx-auto bg-white rounded-3xl overflow-hidden shadow-2xl">
                            <div className="bg-gray-100 p-4 flex justify-between items-center border-b sticky top-0 z-20">
                                <h2 className="text-xl font-bold flex items-center gap-2">å­¸ç¿’ç´€éŒ„ ({userName})</h2>
                                <div className="flex gap-2">
                                    <button onClick={exportReport} disabled={isExporting} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2">
                                        <Share2 size={18} /> {isExporting ? 'è™•ç†ä¸­...' : 'ç”¢ç”Ÿåˆ†äº«åœ–ç‰‡'}
                                    </button>
                                    <button onClick={() => closeReportModal()} className="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold hover:bg-gray-400">é—œé–‰</button>
                                </div>
                            </div>

                            <div className="relative">
                                {/* Success Image Overlay for LINE/Mobile */}
                                {reportImageUrl && (
                                    <div className="absolute inset-0 bg-black/95 z-40 flex flex-col p-2 animate-in fade-in duration-300">
                                        <button onClick={() => setReportImageUrl(null)} className="absolute top-4 right-4 text-white hover:text-gray-300 z-50 bg-white/20 p-2 rounded-full transition-colors focus:outline-none backdrop-blur-md">
                                            <X size={24} />
                                        </button>

                                        <div className="flex-1 flex flex-col min-h-0 pt-10">
                                            <div className="flex-1 flex items-center justify-center overflow-hidden p-2">
                                                <img src={reportImageUrl} className="max-w-full max-h-full object-contain rounded-lg shadow-2xl border-2 border-white/20" alt="Report" />
                                            </div>

                                            <div className="text-center py-4 bg-black/40 backdrop-blur-sm rounded-2xl mx-2 mb-2 border border-white/10">
                                                <p className="text-white text-base font-black mb-1">âœ¨ å ±è¡¨è£½ä½œå®Œæˆï¼ âœ¨</p>
                                                <p className="text-orange-400 text-sm font-bold mb-3">ğŸ‘‰ è«‹é•·æŒ‰ä¸Šæ–¹åœ–ç‰‡åˆ†äº«çµ¦è€å¸«</p>
                                                <Button onClick={() => setReportImageUrl(null)} colorClass="bg-white/10 hover:bg-white/20 text-white border-white/40 ring-1 ring-white/30 text-xs py-2 px-4">é—œé–‰é è¦½</Button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div ref={reportRef} className="p-8 bg-white min-h-[600px]">
                                    <div className="text-center mb-8 border-b-2 border-orange-100 pb-6">
                                        <h1 className="text-4xl font-black text-orange-600 mb-2">Grammar Adventure Record</h1>
                                        <div className="flex justify-center gap-6 text-gray-600 font-medium">
                                            <p>Student: <span className="text-black font-bold text-xl">{userName}</span></p>
                                            <p>Date: {new Date().toLocaleDateString()}</p>
                                        </div>
                                    </div>

                                    <div className="space-y-8">
                                        {recordsToDisplay.map((record) => {
                                            const data = grammarData[record.sectionKey];
                                            return (
                                                <div key={record.id} className="border-2 border-gray-100 rounded-2xl overflow-hidden break-inside-avoid shadow-sm">
                                                    <div className={`p-4 ${data.color || 'bg-gray-100'}`}>
                                                        <h3 className="font-bold text-lg text-gray-800">{data.title} ({selectedRecord ? 'ä½œç­”ç´€éŒ„' : 'æœ€æ–°ä½œç­”'})</h3>
                                                        <p className="text-xs opacity-70">{new Date(record.timestamp).toLocaleString()}</p>
                                                    </div>
                                                    <div className="p-4 bg-white">
                                                        <table className="w-full text-left">
                                                            <thead>
                                                                <tr className="border-b text-gray-400 text-sm">
                                                                    <th className="pb-2 w-12">é¡Œè™Ÿ</th>
                                                                    <th className="pb-2">é¡Œç›®</th>
                                                                    <th className="pb-2">ä½ çš„ç­”æ¡ˆ</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody className="divide-y">
                                                                {record.details && record.details.map((detail, i) => (
                                                                    <tr key={i}>
                                                                        <td className="py-3 text-gray-500">{i + 1}</td>
                                                                        <td className="py-3 font-medium text-gray-800">
                                                                            {detail.question.split('__________').map((part, pi) => (
                                                                                <span key={pi}>
                                                                                    {part}
                                                                                    {pi === 0 && <span className="underline decoration-dotted decoration-gray-400 mx-1">____</span>}
                                                                                </span>
                                                                            ))}
                                                                        </td>
                                                                        <td className="py-3 font-bold text-blue-600">
                                                                            {detail.userAnswer}
                                                                        </td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {userHistory.length === 0 && <p className="text-center text-gray-400 py-8">ç›®å‰æ²’æœ‰ä½œç­”ç´€éŒ„</p>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (showNameModal) {
                return (
                    <div className="fixed inset-0 bg-orange-50 z-50 flex items-center justify-center p-4">
                        <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full border-4 border-orange-200 text-center">
                            <span className="text-6xl mb-4 block">ğŸ‘‹</span>
                            <h2 className="text-3xl font-black text-orange-600 mb-2">Welcome!</h2>
                            <p className="text-gray-500 mb-6">æ­¡è¿ä¾†åˆ° Grammar Adventureï¼Œè«‹å•ä½ å«ä»€éº¼åå­—ï¼Ÿ</p>
                            <form onSubmit={handleNameSubmit}>
                                <input type="text" value={userName} onChange={(e) => setUserName(e.target.value)} placeholder="Enter your name" className="w-full text-center text-xl p-3 border-b-4 border-gray-300 focus:border-orange-500 outline-none bg-gray-50 rounded-t-lg mb-6 transition-colors" autoFocus required />
                                <Button className="w-full text-lg" colorClass="bg-orange-500 hover:bg-orange-600">é–‹å§‹å†’éšª Start!</Button>
                            </form>
                        </div>
                    </div>
                );
            }



            if (!currentSection) {
                return (
                    <div className="min-h-screen bg-orange-50 font-sans p-4 md:p-8 relative">
                        {notification && (
                            <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-full shadow-lg z-50 flex items-center gap-2 animate-[slideDown_0.5s_ease-out]">
                                <Bell className="w-5 h-5" />
                                <span className="font-bold">{notification}</span>
                                <button onClick={() => setNotification(null)} className="ml-2 hover:bg-green-600 rounded-full p-1">X</button>
                            </div>
                        )}

                        <div className="max-w-4xl mx-auto">
                            <header className="flex flex-col md:flex-row items-center justify-between mb-12 gap-4">
                                <div className="text-center md:text-left">
                                    <h1 className="text-4xl md:text-5xl font-black text-orange-600 mb-2 drop-shadow-md tracking-tight">
                                        Grammar Adventure
                                    </h1>
                                    <p className="text-lg text-gray-600 font-medium">Hi, <span className="text-orange-600 font-bold border-b-2 border-orange-300">{userName}</span>! æº–å‚™å¥½å¾æœè‹±æ–‡æ™‚æ…‹äº†å—ï¼ŸğŸš€</p>
                                </div>
                                <button
                                    onClick={handleSwitchUser}
                                    className="flex items-center gap-2 bg-white px-4 py-2 rounded-xl shadow-sm border-2 border-orange-100 text-orange-600 font-bold hover:bg-orange-50 transition-colors text-sm"
                                >
                                    <LogOut size={16} /> ç™»å‡º / æ›´æ›ä½¿ç”¨è€…
                                </button>
                            </header>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
                                {Object.entries(grammarData).map(([key, data]) => {
                                    const bestScore = getProgress(key);
                                    const progress = (bestScore / data.questions.length) * 100;

                                    return (
                                        <button
                                            key={key}
                                            onClick={() => handleSectionSelect(key)}
                                            className={`group relative overflow-hidden ${data.color} border-4 ${data.borderColor} rounded-3xl p-6 text-left transition-all hover:scale-[1.02] active:scale-95 shadow-[8px_8px_0px_0px_rgba(0,0,0,0.1)]`}
                                        >
                                            <div className="flex justify-between items-start mb-4">
                                                <span className="text-5xl group-hover:animate-bounce">{data.icon}</span>
                                                <div className="text-right"><ArrowRight className={`w-8 h-8 ${data.textColor} opacity-0 group-hover:opacity-100 transition-opacity inline-block`} /></div>
                                            </div>
                                            <h2 className={`text-2xl font-bold ${data.textColor} mb-2`}>{data.title}</h2>
                                            <div className="mt-4 bg-white/50 rounded-full h-3 overflow-hidden border border-white/30">
                                                <div className={`h-full ${data.progressColor} transition-all duration-1000 ease-out`} style={{ width: `${progress}%` }}></div>
                                            </div>
                                            <div className="flex justify-between mt-1">
                                                <p className={`${data.textColor} text-xs font-bold opacity-70`}>{Math.round(progress)}% å®Œæˆ</p>
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>

                            <div className="bg-white rounded-3xl p-6 shadow-sm border-2 border-orange-100">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold text-gray-700 flex items-center gap-2">
                                        <Star className="text-yellow-400" /> æˆ‘çš„å­¸ç¿’æ­·ç¨‹ (My Records)
                                    </h3>
                                    {history.length > 0 && (
                                        <button onClick={clearAllHistory} title="æ¸…é™¤æ‰€æœ‰ä½¿ç”¨è€…çš„ç´€éŒ„" className="text-gray-300 hover:text-red-500 p-2"><Trash2 size={16} /></button>
                                    )}
                                </div>
                                <div className="flex flex-col sm:flex-row gap-4 items-center bg-orange-50 p-6 rounded-2xl">
                                    <div className="flex-1">
                                        <p className="text-gray-600 mb-1">{userName} å·²å®Œæˆ <strong className="text-orange-600">{userHistory.length}</strong> æ¬¡æ¸¬é©—</p>
                                        <p className="text-xs text-gray-400">æ‰€æœ‰çš„ç­”é¡Œç´€éŒ„éƒ½ä¿å­˜åœ¨é€™è£¡ã€‚</p>
                                    </div>
                                    <div className="flex gap-2 w-full sm:w-auto">
                                        {userHistory.length > 0 && (
                                            <Button onClick={resetMyProgress} colorClass="bg-red-400 hover:bg-red-500" className="flex-1 sm:flex-none text-sm px-4">
                                                <RotateCcw size={18} /> é‡ç½®é€²åº¦
                                            </Button>
                                        )}
                                        <Button onClick={() => setShowReportModal(true)} colorClass="bg-gray-800 hover:bg-black" className="flex-1 sm:flex-none text-sm px-4">
                                            æŸ¥çœ‹ç´€éŒ„èˆ‡ä¸‹è¼‰
                                        </Button>
                                    </div>
                                </div>
                            </div>

                            <footer className="mt-16 text-center text-gray-400 font-medium pb-8"><p>Designed for fun learning! âœ¨</p></footer>
                        </div>
                    </div>
                );
            }

            const sectionData = grammarData[currentSection];

            // Quiz View
            return (
                <div className={`min-h-screen ${sectionData.color} font-sans p-4 md:p-8 transition-colors duration-500`}>
                    <div className="max-w-3xl mx-auto">
                        <div className="flex items-center justify-between mb-8 bg-white/60 backdrop-blur-sm p-4 rounded-2xl border-2 border-white/50">
                            <button onClick={handleGoHome} className="flex items-center gap-2 text-gray-600 font-bold hover:text-gray-900 transition-colors">
                                <Home className="w-5 h-5" /> å›é¦–é 
                            </button>
                            <h2 className={`text-xl md:text-2xl font-black ${sectionData.textColor} text-center hidden md:block`}>{sectionData.title}</h2>
                            <div className="w-24 text-right font-bold text-gray-500 flex items-center justify-end gap-2"><User size={16} /> {userName}</div>
                        </div>

                        {!mode && (
                            <div className="flex flex-col gap-6 animate-in slide-in-from-bottom-8 duration-500">
                                <div className="text-center mb-4">
                                    <span className="text-8xl block mb-4 animate-pulse">{sectionData.icon}</span>
                                    <h2 className={`text-3xl font-black ${sectionData.textColor}`}>æº–å‚™å¥½é–‹å§‹äº†å—ï¼Ÿ</h2>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <CartoonCard color="bg-white" borderColor={sectionData.borderColor} className="cursor-pointer hover:bg-gray-50">
                                        <div onClick={() => setMode('learn')} className="h-full flex flex-col items-center justify-center text-center gap-4">
                                            <BookOpen className={`w-16 h-16 ${sectionData.textColor}`} />
                                            <div><h3 className="text-2xl font-bold text-gray-800">å­¸ç¿’æ¨¡å¼</h3><p className="text-gray-500">è¤‡ç¿’é‡é»</p></div>
                                        </div>
                                    </CartoonCard>
                                    <CartoonCard color="bg-white" borderColor={sectionData.borderColor} className="cursor-pointer hover:bg-gray-50">
                                        <div onClick={startQuiz} className="h-full flex flex-col items-center justify-center text-center gap-4">
                                            <Star className={`w-16 h-16 ${sectionData.textColor}`} />
                                            <div><h3 className="text-2xl font-bold text-gray-800">æŒ‘æˆ°æ¨¡å¼</h3><p className="text-gray-500">é–‹å§‹æ¸¬é©—</p></div>
                                        </div>
                                    </CartoonCard>
                                </div>

                                {/* Per-module history list moved inside */}
                                <div className="mt-8 bg-white/50 backdrop-blur-sm rounded-3xl p-6 border-2 border-white/50">
                                    <h3 className={`text-lg font-bold ${sectionData.textColor} mb-4 flex items-center gap-2`}>
                                        <RotateCcw size={18} /> æ­·å²ä½œç­”ç´€éŒ„ (History)
                                    </h3>
                                    <div className="space-y-3">
                                        {userHistory.filter(h => h.sectionKey === currentSection).length === 0 ? (
                                            <p className="text-center py-8 text-gray-500 italic bg-white/30 rounded-2xl">ç›®å‰é‚„æ²’æœ‰ä½œç­”ç´€éŒ„å–”ï¼</p>
                                        ) : (
                                            userHistory.filter(h => h.sectionKey === currentSection).map(record => (
                                                <div key={record.id} className="flex items-center justify-between bg-white p-4 rounded-2xl shadow-sm border border-white group">
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${sectionData.color} ${sectionData.textColor}`}>
                                                            âœ¨
                                                        </div>
                                                        <div>
                                                            <p className="font-bold text-gray-700">{new Date(record.timestamp).toLocaleDateString()}</p>
                                                            <p className="text-xs text-gray-400">{new Date(record.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-3">
                                                        <button onClick={() => viewRecord(record)} className="text-blue-600 font-bold hover:underline px-3 py-1 bg-blue-50 rounded-lg text-sm">æŸ¥çœ‹å…§å®¹</button>
                                                        <button onClick={() => deleteRecord(record.id)} className="text-red-400 font-bold hover:underline px-3 py-1 bg-red-50 rounded-lg text-sm">åˆªé™¤</button>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {mode === 'learn' && (
                            <div className="space-y-6 animate-in fade-in duration-500">
                                {sectionData.rules.map((rule, idx) => (
                                    <CartoonCard key={idx} color="bg-white" borderColor={sectionData.borderColor}>
                                        <h3 className={`text-xl font-black ${sectionData.textColor} mb-3 flex items-center gap-2`}>
                                            <span className="bg-gray-100 text-gray-800 w-8 h-8 rounded-full flex items-center justify-center text-sm">{idx + 1}</span>
                                            {rule.title}
                                        </h3>
                                        <p className="text-gray-700 font-medium mb-4 leading-relaxed whitespace-pre-line">{rule.content}</p>
                                        <div className="bg-gray-50 border-l-4 border-gray-300 p-3 italic text-gray-600 rounded-r-lg">ä¾‹å¥ï¼š {rule.example}</div>
                                    </CartoonCard>
                                ))}
                                <div className="pt-4 text-center">
                                    <Button onClick={startQuiz} colorClass={sectionData.btnColor} className="w-full md:w-auto text-xl mx-auto">é–‹å§‹æ¸¬é©—ï¼ <ArrowRight size={24} /></Button>
                                </div>
                            </div>
                        )}

                        {mode === 'quiz' && !completed && (
                            <div className="max-w-2xl mx-auto animate-in slide-in-from-right-8 duration-300">
                                <div className="mb-8">
                                    <div className="flex justify-between text-sm font-bold text-gray-500 mb-2">
                                        <span>Question {currentQuestionIdx + 1} / {sectionData.questions.length}</span>
                                        <span className="opacity-0">Score hidden</span>
                                    </div>
                                    <div className="h-4 bg-white/50 rounded-full overflow-hidden border border-white/60">
                                        <div className={`h-full ${sectionData.btnColor.split(' ')[0]} transition-all duration-500`} style={{ width: `${((currentQuestionIdx + 1) / sectionData.questions.length) * 100}%` }}></div>
                                    </div>
                                </div>
                                <CartoonCard color="bg-white" borderColor={sectionData.borderColor} className="py-12">
                                    <div className="text-center mb-8">
                                        <h3 className="text-2xl md:text-3xl font-bold text-gray-800 leading-normal">
                                            {sectionData.questions[currentQuestionIdx].q.split('__________').map((part, i, arr) => (
                                                <React.Fragment key={i}>
                                                    {part}
                                                    {i < arr.length - 1 && (
                                                        <span className="inline-block px-2">
                                                            <input key={currentQuestionIdx} type="text" value={userInput} onChange={(e) => setUserInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && checkAnswer()} className="border-b-4 border-gray-300 bg-gray-50 text-center w-40 md:w-56 focus:outline-none focus:border-blue-500 text-blue-600 font-handwriting px-2 py-1 transition-colors rounded-t-lg" placeholder="" autoFocus autoCorrect="off" autoCapitalize="none" spellCheck="false" autoComplete="new-password" />
                                                        </span>
                                                    )}
                                                </React.Fragment>
                                            ))}
                                        </h3>
                                    </div>
                                    <div className="flex justify-center">
                                        <Button onClick={checkAnswer} colorClass={sectionData.btnColor} className="w-full md:w-2/3 text-lg">Check Answer <CheckCircle size={24} /></Button>
                                    </div>
                                </CartoonCard>
                            </div>
                        )}

                        {completed && (
                            <div className="text-center animate-in zoom-in-90 duration-500 flex flex-col items-center">
                                <div className={`bg-white p-8 rounded-3xl shadow-xl border-8 ${sectionData.borderColor} max-w-sm w-full mb-8 relative overflow-hidden`}>
                                    <div className={`absolute top-0 left-0 w-full h-4 ${sectionData.color}`}></div>
                                    <div className="text-center mb-6">
                                        <span className="text-6xl mb-2 block">{score === sectionData.questions.length ? 'ğŸ†' : score > sectionData.questions.length / 2 ? 'ğŸŒŸ' : 'ğŸ’ª'}</span>
                                        <h3 className="text-2xl font-black text-gray-800 uppercase tracking-widest border-b-2 border-gray-100 pb-2">Completed!</h3>
                                    </div>
                                    <div className="bg-gray-50 p-6 rounded-xl mb-4">
                                        <p className="text-xl font-black text-gray-800 tracking-wide">æ¸¬é©—å®Œæˆï¼ä»»å‹™é”æˆï¼â˜€ï¸</p>
                                    </div>
                                    <p className="text-sm text-gray-500">æˆç¸¾å·²å„²å­˜ï¼å›åˆ°é¦–é å¯ä»¥æŸ¥çœ‹æœ€ä½³ç´€éŒ„ã€‚</p>
                                </div>
                                <div className="flex flex-col md:flex-row gap-4 justify-center w-full max-w-md">
                                    <Button onClick={resetQuiz} colorClass="bg-gray-500 hover:bg-gray-600" className="flex-1"><RefreshCw size={20} /> å†ç©ä¸€æ¬¡</Button>
                                    <Button onClick={handleGoHome} colorClass={sectionData.btnColor} className="flex-1"><Home size={20} /> å›åˆ°å¤§å»³</Button>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
